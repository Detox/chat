/*
 0BSD
*/
(function(){function m(c){return(new DataView(c.buffer,c.byteOffset,c.byteLength)).getFloat64(0,!1)}function v(c){var g=new Uint8Array(8);(new DataView(g.buffer)).setFloat64(0,c,!1);return g}function k(c,k,h,w){function f(b,a,e,c){var d=this;null==a&&(a=null);null==e&&(e=3);null==c&&(c=3);if(!(this instanceof f))return new f(b,a,e,c);w.call(this);this.g=b;this.m=a||n(g);this.A=k.create_keypair(this.m);this.o=this.A.ed25519["public"];this.w=e;this.l=c;this.v=this.g.get_max_data_size();this.c=p();this.h=
p();this.i=p();this.j=0;this.g.once("announced",function(b){!d.a&&d.b(b)&&d.fire("announced")}).on("connected",function(b,a){!d.a&&d.b(b)&&(d.c.add(a),d.fire("connected",a))}).on("connection_progress",function(b,a,c){!d.a&&d.b(b)&&d.fire("connection_progress",a,c)}).on("connection_failed",function(b,a,c){!d.a&&d.b(b)&&d.fire("connection_failed",a,c)}).on("disconnected",function(b,a){!d.a&&d.b(b)&&(d.c["delete"](a),d.h["delete"](a),d.i["delete"](a),d.fire("disconnected",a))}).on("introduction",function(a){if(!d.a&&
d.b(a.real_public_key)&&x(q,a.application.subarray(0,q.length)))return d.fire("introduction",a.target_id,a.secret,a.application).then(function(){a.number_of_intermediate_nodes=Math.max(d.l-1,1)})["catch"](y)}).on("data",function(a,b,c,e){if(!d.a&&d.b(a)&&(c===r||c===t||d.s(b)))switch(c){case D:break;case r:if(e.length!==g)break;d.fire("secret",b,e).then(function(){d.i.add(b);d.f(b,t,new Uint8Array(0))})["catch"](y);break;case t:if(!d.h.has(b))break;d.fire("secret_received",b);break;case z:d.fire("nickname",
b,A(e),e);break;case B:if(9>e.length)break;a=e.subarray(0,8);c=m(a);var f=e.subarray(8,16);f=m(f);e=e.subarray(16);d.f(b,C,a);d.fire("text_message",b,c,f,A(e),e);break;case C:d.fire("text_message_received",b,m(e));break;default:c<l||d.fire("custom_command",b,c-l,e)}})}var n=h.random_bytes;var u=h.string2array;var A=h.array2string;var x=h.are_arrays_equal;var E=h.concat_arrays;var y=h.error_handler;var p=h.ArraySet;var q=u("detox-chat-v0");f.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=c.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES;
f.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=c.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES;f.CONNECTION_ERROR_NO_INTRODUCTION_NODES=c.CONNECTION_ERROR_NO_INTRODUCTION_NODES;f.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT=c.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT;f.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=c.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES;f.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=c.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE;f.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=
c.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES;f.CONNECTION_PROGRESS_INTRODUCTION_SENT=c.CONNECTION_PROGRESS_INTRODUCTION_SENT;f.prototype={announce:function(){this.u||this.a||(this.u=!0,this.g.announce(this.m,this.w,Math.max(this.l-1,1)))},connect_to:function(b,a){this.a||this.c.has(b)||this.g.connect_to(this.m,b,q,a,this.l)},nickname:function(b,a){!this.a&&this.c.has(b)&&("string"===typeof a&&(a=u(a)),this.f(b,z,a))},secret:function(b,a){var e;!this.a&&this.c.has(b)&&((e=new Uint8Array(g)).set(a),
this.h.add(b),this.f(b,r,e))},text_message:function(b,a,e){if(this.a||!this.c.has(b))return 0;"string"===typeof e&&(e=u(e));if(!e.length)return 0;var c=+new Date;c<=this.j&&(c=this.j+1);a=E([v(c),v(a),e]);if(a.length>this.v)return 0;this.j=c;this.f(b,B,a);return c},custom_command:function(b,a,c){this.f(b,a+l,c)},destroy:function(){this.a||(this.a=!0)},b:function(b){return x(this.o,b)},s:function(b){return this.h.has(b)&&this.i.has(b)},f:function(b,a,c){this.g.send_to(this.o,b,a,c)}};f.prototype=Object.assign(Object.create(w.prototype),
f.prototype);Object.defineProperty(f.prototype,"constructor",{value:f});return{ready:function(b){function a(){--e;e||b()}var e=2;c.ready(a);k.ready(a)},Chat:f,generate_seed:function(){return n(g)},generate_secret:function(){return n(g)}}}var l;var D=0;var r=1;var t=2;var z=3;var B=4;var C=5;var g=l=32;"function"===typeof define&&define.amd?define(["@detox/core","@detox/crypto","@detox/utils","async-eventer"],k):"object"===typeof exports?module.exports=k(require("@detox/core"),require("@detox/crypto"),
require("@detox/utils"),require("async-eventer")):this.detox_chat=k(this.detox_core,this.detox_crypto,this.detox_utils,this.async_eventer)}).call(this);
/*
 0BSD
*/
(function(){function h(f,h,g,u){function c(b,a,e,f){var d=this;null==a&&(a=null);null==e&&(e=3);null==f&&(f=3);if(!(this instanceof c))return new c(b,a,e,f);u.call(this);this.g=b;this.m=a||m(k);this.A=h.create_keypair(this.m);this.o=this.A.ed25519["public"];this.w=e;this.l=f;this.v=this.g.get_max_data_size();this.c=n();this.h=n();this.i=n();this.j=0;this.g.once("announced",function(a){!d.a&&d.b(a)&&d.fire("announced")}).on("connected",function(a,b){!d.a&&d.b(a)&&(d.c.add(b),d.fire("connected",b))}).on("connection_progress",
function(a,b,e){!d.a&&d.b(a)&&d.fire("connection_progress",b,e)}).on("connection_failed",function(a,b,e){!d.a&&d.b(a)&&d.fire("connection_failed",b,e)}).on("disconnected",function(a,b){!d.a&&d.b(a)&&(d.c["delete"](b),d.h["delete"](b),d.i["delete"](b),d.fire("disconnected",b))}).on("introduction",function(a){if(!d.a&&d.b(a.real_public_key)&&v(p,a.application.subarray(0,p.length)))return d.fire("introduction",a.target_id,a.secret,a.application).then(function(){a.number_of_intermediate_nodes=Math.max(d.l-
1,1)})["catch"](w)}).on("data",function(a,b,e,c){if(!d.a&&d.b(a)&&(e===q||e===r||d.s(b)))switch(e){case B:break;case q:if(c.length!==k)break;d.fire("secret",b,c).then(function(){d.i.add(b);d.f(b,r,new Uint8Array(0))})["catch"](w);break;case r:if(!d.h.has(b))break;d.fire("secret_received",b);break;case x:d.fire("nickname",b,y(c),c);break;case z:if(9>c.length)break;a=c.subarray(0,8);e=(new DataView(a.buffer,a.byteOffset,a.byteLength)).getFloat64(0,!1);c=c.subarray(8);d.f(b,A,a);d.fire("text_message",
b,e,y(c),c);break;case A:d.fire("text_message_received",b,(new DataView(c.buffer,c.byteOffset,c.byteLength)).getFloat64(0,!1));break;default:e<l||d.fire("custom_command",b,e-l,c)}})}var m=g.random_bytes;var t=g.string2array;var y=g.array2string;var v=g.are_arrays_equal;var C=g.concat_arrays;var w=g.error_handler;var n=g.ArraySet;var p=t("detox-chat-v0");c.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=f.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES;c.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=
f.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES;c.CONNECTION_ERROR_NO_INTRODUCTION_NODES=f.CONNECTION_ERROR_NO_INTRODUCTION_NODES;c.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT=f.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT;c.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=f.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES;c.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=f.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE;c.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=f.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES;
c.CONNECTION_PROGRESS_INTRODUCTION_SENT=f.CONNECTION_PROGRESS_INTRODUCTION_SENT;c.prototype={announce:function(){this.u||this.a||(this.u=!0,this.g.announce(this.m,this.w,Math.max(this.l-1,1)))},connect_to:function(b,a){this.a||this.c.has(b)||this.g.connect_to(this.m,b,p,a,this.l)},nickname:function(b,a){!this.a&&this.c.has(b)&&("string"===typeof a&&(a=t(a)),this.f(b,x,a))},secret:function(b,a){var e;!this.a&&this.c.has(b)&&((e=new Uint8Array(k)).set(a),this.h.add(b),this.f(b,q,e))},text_message:function(b,
a){if(this.a||!this.c.has(b))return 0;"string"===typeof a&&(a=t(a));if(!a.length)return 0;var e=+new Date;e<=this.j&&(e=this.j+1);var c=e;var d=new Uint8Array(8);(new DataView(d.buffer)).setFloat64(0,c,!1);a=C([d,a]);if(a.length>this.v)return 0;this.j=e;this.f(b,z,a);return e},custom_command:function(b,a,c){this.f(b,a+l,c)},destroy:function(){this.a||(this.a=!0)},b:function(b){return v(this.o,b)},s:function(b){return this.h.has(b)&&this.i.has(b)},f:function(b,a,c){this.g.send_to(this.o,b,a,c)}};c.prototype=
Object.assign(Object.create(u.prototype),c.prototype);Object.defineProperty(c.prototype,"constructor",{enumerable:!1,value:c});return{ready:function(b){function a(){--c;c||b()}var c=2;f.ready(a);h.ready(a)},Chat:c,generate_seed:function(){return m(k)},generate_secret:function(){return m(k)}}}var l;var B=0;var q=1;var r=2;var x=3;var z=4;var A=5;var k=l=32;"function"===typeof define&&define.amd?define(["@detox/core","@detox/crypto","@detox/utils","async-eventer"],h):"object"===typeof exports?module.exports=
h(require("@detox/core"),require("@detox/crypto"),require("@detox/utils"),require("async-eventer")):this.detox_chat=h(this.detox_core,this.detox_crypto,this.detox_utils,this.async_eventer)}).call(this);
/*
 0BSD
*/
(function(){function q(c){return(new DataView(c.buffer,c.byteOffset,c.byteLength)).getFloat64(0,!1)}function z(c){var g=new Uint8Array(8);(new DataView(g.buffer)).setFloat64(0,c,!1);return g}function k(c,l,h,k){function f(a,b,e,c){var d=this;null==b&&(b=null);null==e&&(e=3);null==c&&(c=3);if(!(this instanceof f))return new f(a,b,e,c);k.call(this);this.g=a;this.m=b||r(g);this.A=l.create_keypair(this.m);this.o=this.A.ed25519["public"];this.w=e;this.l=c;this.v=this.g.get_max_data_size();this.c=t();this.h=
t();this.i=t();this.j=0;this.g.once("announced",function(a){!d.a&&d.b(a)&&d.fire("announced")}).on("connected",function(a,b){!d.a&&d.b(a)&&(d.c.add(b),d.fire("connected",b))}).on("connection_progress",function(a,b,e){!d.a&&d.b(a)&&d.fire("connection_progress",b,e)}).on("connection_failed",function(a,b,e){!d.a&&d.b(a)&&d.fire("connection_failed",b,e)}).on("disconnected",function(a,b){!d.a&&d.b(a)&&(d.c["delete"](b),d.h["delete"](b),d.i["delete"](b),d.fire("disconnected",b))}).on("introduction",function(a){if(!d.a&&
d.b(a.real_public_key)&&u(v,a.application.subarray(0,v.length)))return d.fire("introduction",a.target_id,a.secret,a.application).then(function(){a.number_of_intermediate_nodes=Math.max(d.l-1,1)})["catch"](A)}).on("data",function(a,b,e,c){if(!d.a&&d.b(a)&&(e===w||e===x||d.s(b)))switch(e){case G:break;case w:if(c.length!==g)break;d.fire("secret",b,c).then(function(){d.i.add(b);d.f(b,x,new Uint8Array(0))})["catch"](A);break;case x:if(!d.h.has(b))break;d.fire("secret_received",b);break;case B:d.fire("nickname",
b,y(c),c);break;case C:if(9>c.length)break;a=c.subarray(0,8);e=q(a);var f=c.subarray(8,16);f=q(f);c=c.subarray(16);d.f(b,D,a);d.fire("text_message",b,e,f,y(c),c);break;case D:d.fire("text_message_received",b,q(c));break;default:e<m||d.fire("custom_command",b,e-m,c)}})}function E(a){var b=l.sha3_256(a).subarray(0,2);return H(n([a,b]))}function F(a){var b=I(a);a=b.subarray(0,-2);b=b.subarray(-2);if(!u(J(a).subarray(0,2),b))throw Error("Checksum is not correct");return a}var r=h.random_bytes;var p=h.string2array;
var y=h.array2string;var K=h.hex2array;var L=h.array2hex;var u=h.are_arrays_equal;var n=h.concat_arrays;var A=h.error_handler;var t=h.ArraySet;var H=h.base58_encode;var I=h.base58_decode;var J=l.sha3_256;var v=p("detox-chat-v0");f.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=c.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES;f.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=c.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES;f.CONNECTION_ERROR_NO_INTRODUCTION_NODES=c.CONNECTION_ERROR_NO_INTRODUCTION_NODES;
f.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT=c.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT;f.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=c.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES;f.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=c.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE;f.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=c.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES;f.CONNECTION_PROGRESS_INTRODUCTION_SENT=c.CONNECTION_PROGRESS_INTRODUCTION_SENT;f.prototype={announce:function(){this.u||
this.a||(this.u=!0,this.g.announce(this.m,this.w,Math.max(this.l-1,1)))},connect_to:function(a,b){this.a||this.c.has(a)||this.g.connect_to(this.m,a,v,b,this.l)},nickname:function(a,b){!this.a&&this.c.has(a)&&("string"===typeof b&&(b=p(b)),this.f(a,B,b))},secret:function(a,b){var c;!this.a&&this.c.has(a)&&((c=new Uint8Array(g)).set(b),this.h.add(a),this.f(a,w,c))},text_message:function(a,b,c){if(this.a||!this.c.has(a))return 0;"string"===typeof c&&(c=p(c));if(!c.length)return 0;var e=+new Date;e<=
this.j&&(e=this.j+1);b=n([z(e),z(b),c]);if(b.length>this.v)return 0;this.j=e;this.f(a,C,b);return e},custom_command:function(a,b,c){this.f(a,b+m,c)},destroy:function(){this.a||(this.a=!0)},b:function(a){return u(this.o,a)},s:function(a){return this.h.has(a)&&this.i.has(a)},f:function(a,b,c){this.g.send_to(this.o,a,b,c)}};f.prototype=Object.assign(Object.create(k.prototype),f.prototype);Object.defineProperty(f.prototype,"constructor",{value:f});return{ready:function(a){c.ready(function(){l.ready(function(){a()})})},
Chat:f,generate_seed:function(){return r(g)},generate_secret:function(){return r(g)},id_encode:function(a,b){return E(n([a,b]))},id_decode:function(a){a=F(a);if(a.length<g||a.length>2*g)throw Error("Incorrect ID");return[a.subarray(0,g),a.subarray(g)]},bootstrap_node_encode:function(a,b,c){return E(n([K(a),p(b),new Uint8Array(Uint16Array.of(c).buffer)]))},bootstrap_node_decode:function(a){var b=F(a);if(b.length<g+1+2)throw Error("Incorrect bootstrap node information");a=L(b.subarray(0,g));var c=y(b.subarray(g,
-2));b=(new Uint16Array(b.slice(-2).buffer))[0];return[a,c,b]}}}var m;var G=0;var w=1;var x=2;var B=3;var C=4;var D=5;var g=m=32;"function"===typeof define&&define.amd?define(["@detox/core","@detox/crypto","@detox/utils","async-eventer"],k):"object"===typeof exports?module.exports=k(require("@detox/core"),require("@detox/crypto"),require("@detox/utils"),require("async-eventer")):this.detox_chat=k(this.detox_core,this.detox_crypto,this.detox_utils,this.async_eventer)}).call(this);
/*
 0BSD
*/
(function(){function h(e,h,g,q){function b(c,a,f,e){var d=this;null==a&&(a=null);null==f&&(f=3);null==e&&(e=3);if(!(this instanceof b))return new b(c,a,f,e);q.call(this);this.g=c;this.j=a||m(k);this.u=h.create_keypair(this.j);this.l=this.u.ed25519["public"];this.s=f;this.i=e;this.o=this.g.get_max_data_size();this.c=z();this.h=0;this.g.once("announced",function(a){!d.a&&d.b(a)&&d.fire("announced")}).on("connected",function(a,c){!d.a&&d.b(a)&&(d.c.add(c),d.fire("connected",c))}).on("connection_progress",
function(a,c,f){!d.a&&d.b(a)&&d.fire("connection_progress",c,f)}).on("connection_failed",function(a,c,f){!d.a&&d.b(a)&&d.fire("connection_failed",c,f)}).on("disconnected",function(a,c){!d.a&&d.b(a)&&(d.c["delete"](c),d.fire("disconnected",c))}).on("introduction",function(a){if(!d.a&&d.b(a.real_public_key)&&r(n,a.application.subarray(0,n.length)))return d.fire("introduction",a.target_id,a.secret,a.application).then(function(){a.number_of_intermediate_nodes=Math.max(d.i-1,1)})["catch"](function(a){A(a)})}).on("data",
function(a,c,f,b){if(!d.a&&d.b(a))switch(f){case B:break;case t:d.fire("nickname",c,u(b),b);break;case v:if(b.length!==k)break;d.f(c,w,new Uint8Array(0));d.fire("secret",c,b);break;case w:d.fire("secret_received",c);break;case x:if(9>b.length)break;a=b.subarray(0,8);f=(new DataView(a.buffer,a.byteOffset,a.byteLength)).getFloat64(0,!1);b=b.subarray(8);d.f(c,y,a);d.fire("text_message",c,f,u(b),b);break;case y:d.fire("text_message_received",c,(new DataView(b.buffer,b.byteOffset,b.byteLength)).getFloat64(0,
!1));break;default:f<l||d.fire("custom_command",c,f-l,b)}})}var m=g.random_bytes;var p=g.string2array;var u=g.array2string;var r=g.are_arrays_equal;var C=g.concat_arrays;var A=g.error_handler;var z=g.ArraySet;var n=p("detox-chat-v0");b.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES=e.CONNECTION_ERROR_CANT_FIND_INTRODUCTION_NODES;b.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES=e.CONNECTION_ERROR_NOT_ENOUGH_INTERMEDIATE_NODES;b.CONNECTION_ERROR_NO_INTRODUCTION_NODES=e.CONNECTION_ERROR_NO_INTRODUCTION_NODES;
b.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT=e.CONNECTION_ERROR_CANT_CONNECT_TO_RENDEZVOUS_POINT;b.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES=e.CONNECTION_ERROR_OUT_OF_INTRODUCTION_NODES;b.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE=e.CONNECTION_PROGRESS_CONNECTED_TO_RENDEZVOUS_NODE;b.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES=e.CONNECTION_PROGRESS_FOUND_INTRODUCTION_NODES;b.CONNECTION_PROGRESS_INTRODUCTION_SENT=e.CONNECTION_PROGRESS_INTRODUCTION_SENT;b.prototype={announce:function(){this.m||
this.a||(this.m=!0,this.g.announce(this.j,this.s,Math.max(this.i-1,1)))},connect_to:function(c,a){this.a||this.c.has(c)||this.g.connect_to(this.j,c,n,a,this.i)},nickname:function(c,a){!this.a&&this.c.has(c)&&("string"===typeof a&&(a=p(a)),this.f(c,t,a))},secret:function(c,a){var b;!this.a&&this.c.has(c)&&((b=new Uint8Array(k)).set(a),this.f(c,v,b))},text_message:function(c,a){if(this.a||!this.c.has(c))return 0;"string"===typeof a&&(a=p(a));if(!a.length)return 0;var b=+new Date;b<=this.h&&(b=this.h+
1);var e=b;var d=new Uint8Array(8);(new DataView(d.buffer)).setFloat64(0,e,!1);a=C([d,a]);if(a.length>this.o)return 0;this.h=b;this.f(c,x,a);return b},custom_command:function(c,a,b){this.f(c,a+l,b)},destroy:function(){this.a||(this.a=!0)},b:function(b){return r(this.l,b)},f:function(b,a,f){this.g.send_to(this.l,b,a,f)}};b.prototype=Object.assign(Object.create(q.prototype),b.prototype);Object.defineProperty(b.prototype,"constructor",{enumerable:!1,value:b});return{ready:function(b){function a(){--c;
c||b()}var c=2;e.ready(a);h.ready(a)},Chat:b,generate_seed:function(){return m(k)},generate_secret:function(){return m(k)}}}var l;var B=0;var v=1;var w=2;var t=3;var x=4;var y=5;var k=l=32;"function"===typeof define&&define.amd?define(["@detox/core","@detox/crypto","@detox/utils","async-eventer"],h):"object"===typeof exports?module.exports=h(require("@detox/core"),require("@detox/crypto"),require("@detox/utils"),require("async-eventer")):this.detox_chat=h(this.detox_core,this.detox_crypto,this.detox_utils,
this.async_eventer)}).call(this);